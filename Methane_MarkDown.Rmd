---
title: "Methane in Hector"
author: "Natalie Crowe"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: readable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Building a Hector Core

Our first step is to create a core. Hector will use this to pull data from existing climate projections. Our projections will be from SSP245.

```{r  Hector-core, message=FALSE}
library(hector)
library(ggplot2)
library(dplyr)
ini_file <- system.file("input/hector_ssp245.ini", package = "hector")
core <- newcore(ini_file)
run(core)
```

## Methane Emissions Data and Graph

After creating and running the core we query it for methane-related outputs
between the years of 1745 and 2100. Hector has several options that relate to methane, including emissions, concentration, postindustrial, natural, soil lifetime and stratosphere lifetime.

```{r Emissions-data-frame}
results<- fetchvars(core, 1745:2100, c(EMISSIONS_CH4(), CONCENTRATIONS_CH4()))
head(results)
```

### Plot Results Methane Emissions

Now we have all the things we need to build a simple plot of methane emissions between the years 1745 and 2100. The `ggplot2` package is helpful for making graphs quickly and simply. We already loaded this package at the beginning of this file. 

```{r Emissions-plot}
results %>% 
  filter(variable == EMISSIONS_CH4()) %>% 
  ggplot(aes(x= year, y= value))+
    geom_line(color="blue")+
    labs(x = "Year",
         y = "Methane Emissions (Tg)",
         title = "Methane Emissions 1745-2100 in SSP245")
```

## Methane Concentrations

By changing the input `EMISSION_CH4()` to `CONCENTRATIONS_CH4()` we can replicate our code to get different visualized data.

```{r Concentration-graph}
results %>% 
  filter(variable == CONCENTRATIONS_CH4()) %>% 
  ggplot(aes(x= year, y= value))+
    geom_line(color= "red")+
    labs(x = "Year",
         y = "Methane Concentration (ppbv)",
         title = "Methane Concentration 1745-2100 in SSP245")
```

### Adding Another Dataframe
Let’s compare this data to NOAA’s data of yearly mean CH4 increase. We first have to read the file using read.table, then we can assign names to each column.
```{r noaa-data}
noaa<- read.table("noaa_data/ch4_annmean_gl.txt.txt", skip = 61)
noaa_data <- noaa %>%
  rename(year = V1, mean = V2, unc = V3) %>%
  select(-unc)

```

We then tell hector we want to look at CH4 concentration in the years corisponding to the NOAA data.

```{r hector-data}
hector_data <- results %>%
  filter(year %in% noaa_data$year,
         variable == "CH4_concentration") %>%
   select(year,
         mean = value)
```

We can then plot for the hector and NOAA data at once.

```{r NOAA-plot}
ggplot() +
  geom_line(data = noaa_data, aes(x = year, y = mean, color = "NOAA")) +
  geom_line(data = hector_data, aes(x = year, y = mean, color = "Hector")) +
  labs(x = "Year", 
       y = "ppb",
       color = "Source")
```


## Comparison Plots

We can put these two results into a single graph...
```{r Comparison-graph}
ggplot(data= results, aes(x= year, y= value, color= units))+
    geom_line()+
    labs(x = "Year",
         y = NULL,
         title = "Methane Concentration/Emission 1745-2100 in SSP245",
         color = "Units") + facet_wrap(~variable)
```
... to show our data side-by-side.

## Sensitivity Analysis

To examine SSP245's Natural methane  sensitivity we first ask hector to fetch data for the `NATURAL_CH4` constant. We then create a function to run this parameter set to a particular value. 

```{r call-for-param}
core <- newcore(ini_file)
run(core)
default<- fetchvars(core, NA, NATURAL_CH4())

param<- function(core, parameter, value) {
  old_value <- fetchvars(core, NA, parameter)
  unit <- as.character(old_value[["units"]])
  setvar(core, NA, parameter, value, unit)
  reset(core)
  run(core)
  result <- fetchvars(core, 2000:2100)
  result[["parameter_value"]] <- value
  result
}
```

Then we tell hector to run a range of values. In this case we ask for 20% above and bellow the set value of `NATURAL_CH4`(341Tg) at intervals of 5 +/-20%. These set values are labelled as `ch4-seq`.

```{r sen-param}
run_with_param_range <- function(core, parameter, values) {
  mapped <- Map(function(x) param(core, parameter, x), values)
  Reduce(rbind, mapped)
}
valuen<- default %>%
  select(value)
meann<- valuen$value
ch4_low <- meann * (1 - 0.2)
ch4_high <- meann * (1 + 0.2)
ch4_seq <- seq(ch4_low, ch4_high, 5)
sensitivity_emission <- run_with_param_range(core, NATURAL_CH4(), ch4_seq)
```

Once we have our differing model outputs we can create a graph. Using the graph function `facet_wrap`to separate the results based on variable. 

```{r sen-graph}
ggplot(sensitivity_emission) +
  aes(x = year, y = value, color = parameter_value, group = parameter_value) +
  geom_line() +
  facet_wrap(~variable, scales = "free_y") +
  labs(color = "NATURAL CH4 (Tg)") +
  scale_color_viridis_c() 
```

### Adding a Histogram 

Using the same `Natural_CH4` data, we can also make a histogram plot. Since we already made `ch4_low` and `ch4_high` with levels +/-20%, we can re-purpose them for this graph.

```{r rnorm}
sdn<- meann*0.2
data<- data.frame(value= rnorm(1000, meann, sdn))
```

Then we can use `ggplot2` to create a histogram with the randomized values.
```{r hist}
ggplot(data, aes(x=value))+
  geom_histogram(binwidth = 1)+
  labs( x= "Natural CH4 Level", y= "count", main= "Natural CH4 Histogram")
invisible(shutdown(core))
```


## Multiple Parameter Run

Working with two parameters `NATURAL_CH4` and `PREINDUSTRIAL_CH4`

```{r core}
core <- newcore(ini_file)
run(core)
results <- fetchvars(core, NA, c(NATURAL_CH4(), PREINDUSTRIAL_CH4()))
```

Normal Distribution

```{r rnorm}
nat_value<- results %>%
  filter(variable== "CH4N") 
nat_mean<- nat_value$value
nat_sd<- nat_mean*0.2
nat_data<- data.frame(value= rnorm(1000, nat_mean, nat_sd))

pre_value<- results %>%
  filter(variable== "M0") 
pre_mean<- pre_value$value
pre_sd<- pre_mean*0.2
pre_data<- data.frame(value= rnorm(1000, pre_mean, pre_sd))
```

Combining data frames

```{r data_frame}
data<- bind_cols(pre_data, nat_data)

```

Altering function to have multiple parameters

```{r function_mod}
multi_param<- function(core, parameter_1, value_1, parameter_2, value_2) {
  old_value <- fetchvars(core, NA, parameter_1)
  old_value2 <- fetchvars(core, NA, parameter_2)
  unit <- as.character(old_value[["units"]], old_value2[["units2"]])
  setvar(core, NA, parameter_1, value_1, unit_1)
  setvar(core, NA, parameter_2, value_2, unit_2)
  reset(core)
  run(core)
  result <- fetchvars(core, 2000:2100)
  result[["parameter_value"]] <- value
  result
}

run_with_multi_param_range <- function(core, parameter_1, values_1, parameter_2, values_2) {
  mapped_1 <- Map(function(x) multi_param(core, parameter_1, x), values_1)
  Reduce(rbind, mapped1)
  mapped_2 <- Map(function(x) multi_param(core, parameter_2, x), values_2)
  Reduce(rbind, mapped2)
}
```

Setting sequences and running function

```{r}
seq_function<- function(data, column) {
  value<- data %>%
    select(column)
  alldata<- value$column
  mean<- mean(alldata)
  low<- mean * (1-0.2)
  high<- mean * (1+0.2)
  sequence<- seq(low, high, 5)
}
seq_function(data, value...2)

valuen<- data %>%
  select(value...2)
allnat<- valuen$value...2
meann<- mean(allnat)
nat_low <- meann * (1 - 0.2)
nat_high <- meann * (1 + 0.2)
nat_seq <- seq(nat_low, nat_high, 5)

valuep<- data %>%
  select(value...1)
allpre<- valuep$value...1
meanp<- mean(allpre)
pre_low <- meanp * (1 - 0.2)
pre_high <- meanp * (1 + 0.2)
pre_seq <- seq(pre_low, pre_high, 5)

sensitivity_emission <- run_with_multi_param_range(core, NATURAL_CH4(), nat_seq, PREINDUSTRIAL_CH4(), pre_seq)
```

